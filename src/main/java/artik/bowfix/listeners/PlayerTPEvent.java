package artik.bowfix.listeners;

import artik.bowfix.BowFix;
import artik.bowfix.utils.BaseUtils;
import artik.bowfix.utils.PlayerUtils;
import org.bukkit.Bukkit;
import org.bukkit.entity.AbstractArrow;
import org.bukkit.entity.EntityType;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntitySpawnEvent;
import org.bukkit.event.player.PlayerChangedWorldEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerTeleportEvent;

public class PlayerTPEvent implements Listener
{
    private BaseUtils db;
    
    public PlayerTPEvent()
    {
        try
        {
            db = new BaseUtils();
        }
        catch(Exception e)
        {
            e.printStackTrace();
            if (BowFix.instance != null) Bukkit.getPluginManager().disablePlugin(BowFix.instance);
        }
    }
    
    @EventHandler
    public void onTeleport(PlayerTeleportEvent e)
    {
        if (PlayerUtils.isDrawing(e.getPlayer()))
        {
            db.add(PlayerUtils.getName(e.getPlayer()));
            
            if (db.count(PlayerUtils.getName(e.getPlayer())) >= 5)
            {
                String message = BowFix.instance.getConfig().getString("messages.events.kicked");
                if (message == null) throw new IllegalStateException();
                e.getPlayer().kickPlayer(message.replace("&","ยง"));
                BowFix.LOG.warning("[PROTECTION] " + PlayerUtils.getName(e.getPlayer()) + " was kicked by using BowExploit!");
    
                db.remove(e.getPlayer().getName());
            }
            else
            {
                String message = BowFix.instance.getConfig().getString("messages.events.warn");
                if (message != null) e.getPlayer().sendMessage(message.replace("&","ยง"));
            }
        }
    }
    
    @EventHandler
    public void onPlayerChangedWorldEvent(PlayerChangedWorldEvent e)
    {
        db.remove(PlayerUtils.getName(e.getPlayer()));
    }
   
    
    @EventHandler
    public void onAccess(PlayerJoinEvent e)
    {
        PlayerUtils.restrictAccess(e.getPlayer());
    }
    
    @EventHandler
    public void onArrowSpawn(EntitySpawnEvent e)
    {
        if (e.getEntityType() != EntityType.ARROW && e.getEntityType() != EntityType.SPECTRAL_ARROW) return;
    
        AbstractArrow arrow = (AbstractArrow) e.getEntity();
        
        if (arrow.getVelocity().lengthSquared() > PlayerUtils.getSqr(3.2))
        {
            arrow.remove();
         
            return;
        }
        
        arrow.setCritical(false);
    }
}
